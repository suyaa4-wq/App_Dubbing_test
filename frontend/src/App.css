import { useState } from 'react';
import './App.css';

function App() {
  const [videoFile, setVideoFile] = useState(null);
  const [audioBlob, setAudioBlob] = useState(null);
  const [isRecording, setIsRecording] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [downloadUrl, setDownloadUrl] = useState('');

  // --- REKAM SUARA ---
  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);

      const chunks = [];
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/wav' });
        setAudioBlob(blob);
        alert('Rekaman selesai! Klik "Ganti Audio" untuk dubbing.');
      };

      mediaRecorder.start();
      setIsRecording(true);
      setTimeout(() => {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
      }, 5000); // Auto stop setelah 5 detik
    } catch (err) {
      alert('Gagal akses mikrofon: ' + err.message);
    }
  };

  // --- UPLOAD VIDEO & AUDIO → DUBBING ---
  const handleDubbing = async () => {
    if (!videoFile) {
      alert('Silakan unggah video terlebih dahulu!');
      return;
    }
    if (!audioBlob) {
      alert('Silakan rekam suara terlebih dahulu!');
      return;
    }

    setIsProcessing(true);

    const formData = new FormData();
    formData.append('video', videoFile);
    formData.append('audio', audioBlob, 'recording.wav');

    try {
      const response = await fetch('https://dubbing-app-backend.onrender.com/dubbing', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error);
      }

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      setDownloadUrl(url);

      alert('✅ Dubbing selesai! Klik "Download Hasil" untuk menyimpan.');
    } catch (error) {
      alert('❌ Gagal dubbing: ' + error.message);
    } finally {
      setIsProcessing(false);
    }
  };

  // --- DOWNLOAD FILE HASIL DUBBING ---
  const downloadResult = () => {
    if (!downloadUrl) return;
    const a = document.createElement('a');
    a.href = downloadUrl;
    a.download = 'dubbed-video.mp4';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(downloadUrl);
    setDownloadUrl('');
  };

  return (
    <div className="App">
      <header className="App-header">
        <h1>🎵 Dubbing-App</h1>
        <p>Upload video → rekam suara → ganti audio → download hasil!</p>
      </header>

      <main style={{ padding: '20px', textAlign: 'center' }}>
        {/* UPLOAD VIDEO */}
        <input
          type="file"
          accept="video/*"
          onChange={(e) => setVideoFile(e.target.files[0])}
          style={{ marginBottom: '20px', padding: '10px' }}
        />

        {/* REKAM SUARA */}
        <button
          onClick={startRecording}
          disabled={isRecording}
          style={{
            margin: '10px',
            padding: '12px 20px',
            backgroundColor: isRecording ? '#ccc' : '#28a745',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            fontSize: '16px',
          }}
        >
          {isRecording ? '⏳ Rekam... (5 detik)' : '🎙️ Rekam Suara Baru'}
        </button>

        {audioBlob && (
          <p style={{ color: '#007bff', marginTop: '10px' }}>
            ✅ Suara direkam ({(audioBlob.size / 1000).toFixed(1)} KB)
          </p>
        )}

        {/* GANTI AUDIO (DUBBING) */}
        <button
          onClick={handleDubbing}
          disabled={!videoFile || !audioBlob || isProcessing}
          style={{
            margin: '10px',
            padding: '12px 20px',
            backgroundColor: !videoFile || !audioBlob || isProcessing ? '#ccc' : '#007bff',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            fontSize: '16px',
          }}
        >
          {isProcessing ? '⏳ Memproses...' : '🎬 Ganti Audio (Dubbing)'}
        </button>

        {/* DOWNLOAD HASIL */}
        {downloadUrl && (
          <button
            onClick={downloadResult}
            style={{
              margin: '10px',
              padding: '12px 20px',
              backgroundColor: '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              fontSize: '16px',
            }}
          >
            📥 Download Hasil Dubbing
          </button>
        )}

        {/* INFO */}
        <div style={{ marginTop: '50px', padding: '20px', backgroundColor: '#f8f9fa', borderRadius: '10px', textAlign: 'left' }}>
          <h3>💡 Cara Kerja:</h3>
          <ol style={{ lineHeight: '1.6' }}>
            <li>Upload video (MP4/MOV)</li>
            <li>Klik “Rekam Suara Baru” → bicara 5 detik</li>
            <li>Klik “Ganti Audio” → server gabungkan video + suara baru</li>
            <li>Klik “Download Hasil” → simpan ke ponsel!</li>
          </ol>
          <p><strong>Fitur ini berjalan di cloud — tidak butuh aplikasi tambahan!</strong></p>
        </div>
      </main>
    </div>
  );
}

export default App;